# Uniswap V2 学习笔记

Uniswap V2是一个**里程碑式**的去中心化交易所（DEX）协议，它基于**自动做市商（AMM）** 模型，允许任何人在以太坊上无需许可地创建交易对并提供流动性，实现了高效的ERC-20代币兑换。

### **一、 核心概念与工作原理**

**1. 两类核心用户**

Uniswap V2的生态由两类主要参与者构成：

- **流动性提供者（LPs）**：为交易对（如DAI/USDC）的资金池同时存入两种等值的ERC-20代币，从而获得代表池中份额的**流动性代币（LP Token）** 作为凭证。他们通过赚取交易者支付的手续费（通常为0.3%）获得收益。
- **交易者**：向资金池存入一种代币，并根据当前汇率从池中取出另一种代币。

**2. 恒定乘积做市商模型**

协议的核心定价机制是 **“恒定乘积公式”**：`x * y = k`。

- `x`和`y`分别代表流动性池中两种代币的储备量。
- `k`是一个在每次交易后（扣除手续费前）保持不变的常数。
- **工作原理**：当交易者用`x`代币购买`y`代币时，`x`的数量增加，`y`的数量减少。为了保持`k`不变，`y`代币的价格会随之上升。这种设计确保了池中始终有流动性，且价格随着买卖行为自动、连续地调整。

**3. 基本工作流程**

![UniswapV2.png](UniswapV2.png)

### **二、 架构设计：核心与外围分离**

Uniswap V2采用模块化设计，将高价值的资产保管逻辑与复杂的交互逻辑分离，以增强安全性。

| **合约类型** | **核心合约** | **外围合约** |
| --- | --- | --- |
| **代表合约** | `UniswapV2Pair.sol` (交易对合约) | `UniswapV2Router02.sol` (路由合约) |
| **核心职责** | **保管资产**。管理特定交易对的流动性池，执行最基础的兑换、流动性添加/移除操作，并维护储备金状态。 | **提供友好接口与高级功能**。处理复杂的交易路由（如多跳兑换）、计算最优输入/输出金额、与WETH（包装ETH）交互等，为用户简化操作。 |
| **安全性要求** | **极高**。代码力求简洁、可审计。 | 相对较低，可灵活升级或替换。 |

这种分离意味着普通用户和开发者通常只与`Router`合约交互，而`Pair`合约则在后台安全地管理资金。

### **三、 核心合约`UniswapV2Pair`源码关键解析**

`UniswapV2Pair.sol`是存放流动性的核心合约，继承自`UniswapV2ERC20`（LP Token的标准实现）。

**1. 关键状态变量**

```
// 使用 uint112 存储储备量，并共享一个256位存储槽以提高Gas效率[citation:1]
uint112 private reserve0;
uint112 private reserve1;
uint32 private blockTimestampLast; // 上次操作的时间戳[citation:1]

address public token0; // 排序后的代币0地址
address public token1; // 排序后的代币1地址
uint public kLast; // 最近一次流动性事件后的 reserve0 * reserve1[citation:1]
```

**2. 核心函数：`swap`**

```
function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;
```

- **功能**：执行一笔兑换。
- **关键逻辑**：
    1. 确保输出金额`amount0Out`或`amount1Out`大于0。
    2. 检查输出后剩余储备量仍满足 `(reserve0 - amount0Out) * (reserve1 - amount1Out) >= kLast`（此处`kLast`为交易前`reserve0 * reserve1`），防止池子被掏空。
    3. 向接收者`to`转账输出代币。
    4. 如果`data`长度大于0，则调用`to`地址的`uniswapV2Call`函数，**这是实现“闪电兑换”的钩子**。
    5. 更新储备金余额，并调用`_update`函数。

**3. 核心函数：`mint` 与 `burn`**

- `mint(address to)`: 当用户**添加流动性**时调用，铸造新的LP Token给`to`地址。铸造数量基于注入的流动性占当前总流动性的比例计算。
- `burn(address to)`: 当用户**移除流动性**时调用，销毁调用者的LP Token，并将对应比例的两种底层代币发送给`to`地址。

**4. 精度与预言机：`_update`函数**

这是协议中最关键的内部函数之一，在每个流动性事件（`mint`, `burn`, `swap`）结束时被调用。

- **更新储备量**：将合约当前的真实代币余额赋值给`reserve0`和`reserve1`。
- **累积价格**：利用`blockTimestampLast`和当前区块时间戳的差，计算并累加`price0CumulativeLast`和`price1CumulativeLast`。这两个值记录了**时间加权平均价格（TWAP）**，为外部协议提供了抗操纵的价格预言机数据。
- **精度处理**：使用`UQ112x112`库（一种224位数，高112位为整数，低112位为小数）来处理计算中的分数，以应对Solidity不支持浮点数的问题。

### **四、 V2的关键特性与改进**

相比于V1，V2引入了多项重要创新：

| **特性** | **描述** | **解决的问题/带来的价值** |
| --- | --- | --- |
| **任意ERC-20交易对** | 支持直接创建ERC-20/ERC-20交易对，无需再通过ETH作为中介。 | 减少了一半的交易步骤和Gas成本，降低了交易滑点。 |
| **时间加权平均价格预言机** | 通过累积价格（`price*CumulativeLast`）为每个池子内置了链上TWAP预言机。 | 极大地增加了价格操纵的成本和难度，为其他DeFi协议（如借贷）提供了可靠的价格输入。 |
| **闪电兑换** | 允许用户在同一笔交易中**先提取代币，再归还或支付其他代币**。 | 无需初始资本即可进行套利，提高了市场效率；也可用于其他复杂的DeFi组合操作（如清算）。 |
| **协议费用开关** | 设计了一个可开关的0.05%协议费用（从0.3%手续费中抽取），收益可导向治理设定的地址。 | 为协议创造了潜在的营收能力，由去中心化治理控制。 |
| **更优的Gas与兼容性** | 用Solidity重写，优化Gas；支持非标准ERC-20代币（如返回`void`的`transfer`）。 | 降低用户成本，提高协议兼容性和用户体验。 |

**无常损失解释**：当流动性提供者存入的代币市场价格比率发生变化时，其持有时与存入资金池产生的资产价值之间的差额。简单来说，如果其中一种代币价格剧烈波动，提供流动性可能比单纯持有这两种代币的收益更低。这是AMM流动性提供者需要承担的主要风险。

### **五、 总结**

Uniswap V2通过其优雅而强大的设计——**恒定乘积公式、核心/外围分离架构、内置TWAP预言机和闪电兑换**——不仅解决了V1的关键限制，更奠定了DeFi Summer的基础，成为无数后续协议组合与创新的“乐高积木”。其代码是学习DeFi和智能合约编程的绝佳范本。