# 合约安全

### **安全设计原则**

- 最小权限原则（Least Privilege）：只授予完成功能所需的最低权限。
- 模块化结构便于审计：将功能分解为独立、可审计的小合约。
- 显式错误处理与事件记录：所有操作可追踪、可审计。

### **常见漏洞类型与防护**

**1、权限控制漏洞**

| **漏洞类型** | **典型表现** | **防护措施** | **真实案例影响** |
| --- | --- | --- | --- |
| **函数权限缺失** | 关键函数未添加权限修饰器 | 使用OpenZeppelin的Ownable/AccessControl；自定义修饰器 | Poly Network攻击（2021），6.1亿美元被盗 |
| **越权访问** | 用户可访问其他用户数据/功能 | 添加`msg.sender`验证；实现基于角色的访问控制(RBAC) | 多个DeFi协议用户资金被非授权转移 |
| **所有者劫持** | 所有者变更函数无验证 | 双重确认机制；时间锁延迟变更 | 多个项目因所有者私钥泄露导致合约被完全控制 |

**2、重入攻击（Reentrancy）**

**攻击原理**：利用代码执行的空隙，状态未更新时多次调用同一个合约

```
// 漏洞代码示例
function withdraw(uint _amount) public {
    require(balances[msg.sender] >= _amount);
    (bool success, ) = msg.sender.call{value: _amount}(""); // 外部调用
    balances[msg.sender] -= _amount; // 状态更新在外部调用后
}
```

**防护方案**：

①检查-生效-交互模式：先更新状态再执行外部调用

②重入锁：使用布尔锁防止重入

③使用OpenZeppelin的ReentrancyGuard

**3、 整数溢出/下溢**

**防护方案**：

- **Solidity 0.8.0+**：默认启用安全数学运算
- **低版本**：使用SafeMath库
- **边界检查**：手动验证运算结果范围

**4、预言机操纵与价格攻击**

**常见攻击形式**：

1. **闪电贷+价格操纵**：借巨资操纵流动性池价格
2. **延迟数据攻击**：利用预言机更新延迟套利

**防护措施**：

- 使用多个预言机源取中位数
- 设置价格波动率限制
- 添加时间加权平均价格(TWAP)
- 对关键操作实施延迟执行