# 基础概念了解回顾——Week1Day2

## 一、网络结构与节点类型

### 核心结论

以太坊网络由分布式节点通过 P2P 协议构成，节点需同时运行执行客户端与共识客户端（合并后），按功能分为全节点、轻节点、归档节点，通过节点发现、加密通信、数据同步机制保障去中心化与数据一致性，是以太坊安全与抗审查性的基础。

### 关键知识点

**1、节点与客户端软件**

**①节点定义：**运行以太坊客户端并连接其他节点的计算机，是网络的核心组成单元。

**②客户端分类：**合并后需同时运行执行客户端（EL，如 Geth、Nethermind）和共识客户端（CL，如 Lighthouse、Prysm），通过 Engine API 协同。

**③执行客户端功能：**处理交易、执行 EVM 逻辑、维护账户状态、提供 JSON-RPC 接口（eth_*）。

**④共识客户端功能：**管理 PoS 共识、区块提议与投票、跟踪验证者状态、维护信标链视图。

**⑤验证者客户端：**作为共识客户端插件，管理验证者密钥，参与区块提议与投票，需质押≥32 ETH。

**2、节点间通信机制**

**①节点发现：**基于 UDP+Kademlia 协议，新节点通过引导节点（boot nodes）获取邻居列表，通过 Ping/Pong 确认在线状态，FindNode 请求邻居地址。

**②连接建立：**通过 TCP 建立稳定连接，RLPx 协议实现加密通信与多路复用，在单一 TCP 通道上承载区块同步、交易传播等子协议。

**③数据传播：**采用 Gossip 协议，节点收到新交易 / 区块后随机转发给少数邻居，实现秒级全网扩散；历史数据通过点对点请求 - 响应模式按需拉取。

**3、节点同步模式**

**①Full Sync（全同步）：**从创世块逐块执行所有交易，重建状态，最安全但耗时数天，适合审计场景。

**②Snap Sync（快照同步）：**下载最新区块头 + 状态快照，并发填充状态数据，数小时到 1 天完成，为全节点默认模式。

**③Light Sync（轻同步）：**仅下载区块头，依赖全节点提供数据证明，适合资源受限设备。

**4、关键技术细节**

**①合并后客户端协同：**共识客户端通过 Engine API 向执行客户端请求区块 payload，执行客户端执行交易后返回结果，共识客户端打包并广播区块。

**②Gossip 协议价值：**去中心化传播，容错性强，单个节点离线不影响全网同步，传播延迟低（秒级）。

**③节点搭建流程：**选择节点类型→配置硬件（全节点需 1TB SSD+16GB 内存）→安装 EL+CL 客户端→选择同步模式→开启 RPC 接口→配置防火墙与监控。

## 二、账户类型与结构

### 核心结论

以太坊账户分为 EOA（外部拥有账户）和合约账户两类，EOA 由私钥控制，可主动发起交易；合约账户由代码驱动，被动响应调用，两者通过地址（0x 开头 20 字节）标识，共同支撑链上资产流转与逻辑执行。

### 关键知识点

**1、EOA（外部拥有账户）**

**①定义：**由公私钥对控制的账户，无内置代码，可主动发起交易（转账、调用合约），持有 ETH 与各类代币。

**②核心字段：**地址（公钥派生）、nonce（交易计数器，防止重放攻击）、balance（ETH 余额，以 wei 为单位）、code/storage（均为空）。

**③控制方式：**私钥签名交易，验证者通过公钥验证签名合法性；助记词（BIP-39）派生私钥，支持多地址管理；MetaMask 等钱包通过本地加密存储私钥 / 助记词。

**④安全要点：**私钥 / 助记词泄露即资产丢失，无找回机制；硬件钱包可提升私钥安全性，避免联网暴露。

**2、合约账户**

**①定义：**无私钥，由部署的 EVM 字节码决定行为，有独立地址、balance、code（运行时代码）、storage（状态变量存储）。

**②创建流程：**EOA 或工厂合约发起创建交易（to 字段为空，data 字段为 init code + 构造函数参数）→EVM 执行 init code→生成 runtime code 并写入链上→初始化 storage→生成合约地址。

**③地址计算：**CREATE 方式由 “部署者地址 + nonce” 决定，公式为 keccak256 (RLP ([sender, nonce])) 后 20 字节；CREATE2 方式由 “部署者地址 + salt+keccak256 (init code)” 决定，支持地址预计算。

**④核心限制：**不能主动发起交易，仅能被 EOA 或其他合约调用；代码默认不可篡改，可通过代理模式实现升级。

**3、地址与账户交互**

**①地址格式：**以 “0x” 开头的 40 位十六进制字符串（20 字节），0x 前缀为十六进制标识，符合编程界传统。

**②EIP-55 校验和：**混合大小写标识地址，通过大小写模式校验输入正确性，降低手动输入错误风险。

**③账户交互机制：**EOA 通过交易调用合约（指定 to 地址 + calldata）→EVM 加载合约代码→执行函数逻辑→更新 storage / 余额→触发事件；合约间通过 call/delegatecall/staticcall 实现内部调用，共享同一交易的 Gas 限额。

**4、代币与账户的关系**

**①ERC-20 代币：**通过合约账户的 mapping 存储余额（mapping (address=>uint256)）与授权额度，转账本质是调用合约 transfer/transferFrom 函数，更新存储状态。

**②ERC-721 代币：**通过 mapping (uint256=>address) 记录 tokenId 与所有者映射，支持唯一资产确权（如数字艺术品）。

**③代币操作流程：**EOA 发起交易→调用代币合约函数→合约验证权限 / 余额→更新存储→触发 Transfer 事件→区块浏览器记录交易。

## 三、智能合约理论基础

### 核心结论

智能合约是部署在链上的 “代码 + 状态” 组合，通过 Solidity 等语言编写、EVM 执行，具备自动执行、公开透明、不可篡改特性，是以太坊应用生态的核心载体，开发流程涵盖编写、编译、部署、调用，需重点关注安全漏洞防范。

### 关键知识点

**1、智能合约核心特性**

**①自动执行：**满足预设条件（if...then... 逻辑）即触发，无需第三方干预，如时间锁账户（满 18 岁可提取资金）。

**②结果确定性：**相同输入在任意节点执行结果一致，保障共识一致性。

**③公开透明：**代码与执行记录全网可见，支持链上审计与验证。

**④不可篡改：**部署后代码默认不可修改，可通过代理模式（Proxy）实现功能升级。

**⑤假名性：**交易绑定地址而非实名，链上行为可追踪，隐私需额外设计（如零知识证明）。

**2、Solidity 语言特性**

**①适配 EVM：**专为 EVM 设计，编译后生成字节码，支持所有链上资源操作（存储、Gas、事件）。

**②核心特性：**静态类型、面向对象（继承、接口、抽象合约）、支持结构体 / 映射 / 枚举、图灵完备。

**③生态支持：**配套 Hardhat/Foundry 开发框架、OpenZeppelin 安全库、Remix 浏览器 IDE，工具链成熟。

**④安全增强：**0.8.0 + 版本默认整数溢出检查，支持自定义错误（error 类型），降低漏洞风险。

**⑤学习路径：**基础概念→官方文档 + Remix 实操→Hardhat/Foundry 工具使用→安全漏洞学习→项目实战（如 ERC-20 代币开发）。

**3、合约编译与部署**

**①编译产物：**init code（部署时执行，含构造函数）、runtime code（链上运行代码）、ABI（JSON 格式接口描述，含函数 / 事件参数）、metadata（编译器版本、源码哈希）。

**②部署流程：**编写代码→编译生成字节码 + ABI→EOA 发起创建交易（支付 Gas）→EVM 执行 init code→写入 runtime code 与初始 storage→返回合约地址。

**③部署成本：**Gas 消耗 = 基础交易成本（21000 Gas）+CREATE 指令成本（32000 Gas）+ 字节码存储成本（200 Gas / 字节）+ 构造函数执行成本，总费用 = GasUsed×(BaseFee+PriorityFee)。

**4、常见安全漏洞与防范**

**①重入攻击：**通过 CEI 模式（Checks→Effects→Interactions）、ReentrancyGuard 修饰符、Pull-Payment 提现模式防范。

**②整数溢出 / 下溢：**使用 Solidity 0.8.0 + 版本（默认检查），必要时用 unchecked 块优化 Gas。

**③访问控制错误：**采用 Ownable/AccessControl 管理权限，禁止使用 tx.origin 鉴权，关键操作搭配多签 + 时间锁。

**④预言机操控：**使用 Chainlink 等去中心化预言机，采用 TWAP（时间加权平均价格），设置滑点限制。

**⑤Gas 耗尽攻击**：避免无上限循环，使用 call 而非 transfer/send 发送 ETH，检查返回值。

**⑥可升级合约风险：**采用 OpenZeppelin Proxy 模板，严格遵守存储布局规则，升级权限交由多签 + 时间锁控制。

**5、部署与调试工具**

**①Remix IDE：**浏览器端 IDE，支持编写、编译、部署、调试，适合入门与快速原型。

**②Hardhat：**Node.js 开发框架，支持脚本化部署、主网 fork 测试、Gas 报告，插件生态丰富。

**③Foundry：**Rust 编写的开发工具链，支持 Solidity 原生测试、模糊测试（fuzzing）、高速编译，适合协议级开发。

**④Tenderly：**云端调试平台，支持交易回放、断点调试、主网 fork 模拟，适合复杂合约调试。