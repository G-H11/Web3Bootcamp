# Uniswap V3 学习笔记

Uniswap V3是**自动做市商（AMM）发展史上的革命性升级**，通过引入“集中流动性”等核心创新，从根本上提升了资本效率，并为流动性提供者（LP）提供了前所未有的控制力。

### **一、 核心理念：从“均分”到“集中”的流动性**

**1. V2的问题：资本效率低下**

在V2中，LP的流动性均匀分布在从0到无穷大的整个价格范围内。这意味着**大部分资金永远闲置**，从未参与交易。例如，一个ETH/DAI池中，只有极小部分流动性用于在ETH价格为$1,800-$2,200的常见区间内交易，其余资金只是在“待命”。

**2. V3的解决方案：集中流动性**

V3允许LP将资金**集中部署在自定义的特定价格区间内**。如果价格保持在该区间内，LP将赚取全部的交易手续费，且因其提供的流动性密度更高，资本效率可以是V2的**数百甚至数千倍**。一旦市场价格超出该区间，其流动性将完全转换为其中一种资产，停止赚取费用，直到价格重新进入区间。

### **二、 核心机制：数学与架构创新**

**1. 新定价曲线：有界常数乘积**

V2的公式 `x * y = k` 演变为V3的 `(x + L / √P_u) * (y + L * √P_l) = L²`，其中：

- `L` 代表“流动性”，是一个综合了两种资产数量的新概念。
- `P_l` 和 `P_u` 分别是流动性区间的**下限价格**和**上限价格**。
- 当价格在区间内时，池子行为类似于V2，但储备金曲线更陡峭（流动性更集中）；当价格触及边界时，其中一种资产耗尽，流动性变为单一资产。

**2. 体系架构：合约交互与资产流动**

Uniswap V3的体系比V2更复杂，其核心合约的交互与用户资产流动遵循以下路径：

**3. 非同质化流动性：NFT 作为凭证**

V2使用同质化的**LP Token**作为凭证。而在V3中，由于每个头寸的价格区间、投入金额和创建时间都独一无二，因此使用**ERC-721非同质化代币**来代表每个流动性头寸。这张NFT记录了头寸的关键参数（如价格区间、流动性份额L等），使其可以独立转让、交易或用于其他DeFi应用。

**4. 多级手续费与协议费用**

- **分层手续费**：V3为不同风险/交易量的交易对提供了**0.05%、0.30%、1.00%**三档手续费等级，由池子创建者选择。这允许稳定币对（如USDC/DAI）采用更低费率以促进高频交易，而非稳定币对（如ETH/DAI）保留较高费率以补偿LP的波动风险。
- **协议费用**：与V2的“开关”不同，V3设计了一个更巧妙的协议费用机制，其激活和费率（不超过LP费用的25%）由去中心化的治理决定。

### **三、 核心代码实现解析**

**1. 核心数据结构：`Slot0`, `Position` 与 `Tick`**

```
// 核心状态变量，存储在单个存储槽中以节省Gas
struct Slot0 {
    uint160 sqrtPriceX96; // 当前价格 (以 sqrt(price) * 2^96 格式存储，兼顾精度与Gas)
    int24 tick;           // 对应的价格tick索引
    ...
}

// 记录某个地址在特定价格区间的头寸信息
struct Position {
    uint128 liquidity; // 该头寸提供的流动性L
    uint256 feeGrowthInside0LastX128; // 用于计算应得手续费的快照
    uint256 feeGrowthInside1LastX128;
}

// 价格刻度管理，每个tick对应一个价格
struct TickInfo {
    uint128 liquidityGross; // 所有以该tick为边界的流动性总和
    int128 liquidityNet;    // 进入/离开该tick时流动性的净变化
    ...
}
```

**2. 关键函数：`mint`, `swap`, `collect`**

- **`mint`**：铸造流动性。根据提供的价格区间和资产数量，计算流动性 `L`，更新对应 `Tick` 的状态，并将头寸信息写入调用者的 `Position` 映射中。
- **`swap`**：执行交易。核心是一个**循环**：在当前的 `tick` 内，按照恒定乘积公式计算；当交换量耗尽当前 `tick` 的流动性时，价格移动到下一个 `tick`，并更新 `sqrtPriceX96` 和 `tick`。这个过程可能跨越多个 `tick`。
- **`collect`**：收取手续费。通过比较当前的 `feeGrowthGlobalX128` 和头寸内存储的 `feeGrowthInsideLastX128` 快照，计算出该头寸应得的累计手续费并提取。

**3. 高精度与Gas优化**

- **`sqrtPriceX96`**：使用 `Q64.96` 定点数（64位整数，96位小数）存储价格的平方根，在极大价格范围和计算精度间取得平衡。
- **`tick`**：价格被离散化为 `tick`。每个 `tick` 对应一个价格，其索引与价格的关系为：`p(i) = 1.0001^i`。这意味着价格每增长0.01%（1个基点），`i`增加1。这种设计允许用整数运算高效地处理对数级的价格变化。

### **四、 高级特性与应用场景**

**1. 范围订单**

V3的流动性头寸可以作为一种“范围订单”。例如，如果当前ETH价格为$2,000，LP可以在$2,100-$2,200的区间提供纯ETH的流动性。如果价格上涨进入该区间，ETH将被逐步卖出为DAI，**自动在目标价位执行了卖出订单**。

**2. 灵活的费用复投策略**

拥有多个集中流动性头寸的LP，可以根据市场走势主动管理。例如，在波动市可以将流动性集中在一个窄区间以获取高费率，在趋势市则可以将区间放宽以避免频繁出界，或跟随价格移动区间以“追逐趋势”。

**3. 更优的预言机**

V3预言机在V2的TWAP基础上进行了重大升级。它不再需要存储所有累积值，而是可以**存储单个最近的观测值**，并允许外部调用者**在任一时间长度内计算TWAP**，大幅降低了链上数据存储和计算的成本。

### **总结**

Uniswap V3通过引入**集中流动性、非同质化头寸和多级费率**，将AMM从一种通用的流动性基础设施，转变为一个**高效、可组合且充满策略性的金融基元**。它代表了DeFi从“简单可用”到“专业高效”的重要转折。尽管其复杂性增加，但它为专业流动性提供者和高级DeFi应用打开了新的大门，继续巩固了Uniswap作为链上金融核心基础设施的地位。